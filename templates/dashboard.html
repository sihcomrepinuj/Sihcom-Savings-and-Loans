{% extends "base.html" %}
{% block title %}Dashboard - Sihcom S&amp;L{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-white">My Savings Goals</h2>
    <a href="{{ url_for('catalog') }}" class="btn btn-outline-success btn-sm">Browse Ships</a>
</div>

{% if orders %}
<div class="row">
    {% for order in orders %}
    {% set bal = balances.get(order['id']) %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card bg-secondary bg-opacity-25 border-secondary h-100">
            {% if order['type_id'] %}
            <img src="{{ order['type_id'] | ship_image(128) }}" class="card-img-top p-2"
                 alt="{{ order['ship_name'] }}" style="height: 120px; object-fit: contain;">
            {% endif %}
            <div class="card-body">
                <h5 class="card-title text-white">{{ order['ship_name'] }}</h5>
                <span class="badge
                    {% if order['status'] == 'pending_approval' %}bg-warning text-dark
                    {% elif order['status'] == 'active' %}bg-success
                    {% elif order['status'] == 'completed' %}bg-primary
                    {% elif order['status'] == 'withdrawal_pending' %}bg-warning text-dark
                    {% elif order['status'] == 'withdrawn' %}bg-info
                    {% else %}bg-secondary{% endif %}
                    mb-2">
                    {{ order['status'] | replace('_', ' ') | title }}
                </span>

                <div class="mb-2">
                    <small class="text-light">Goal</small><br>
                    <strong class="text-white">{{ order['goal_price'] | isk }}</strong>
                </div>

                {% if bal %}
                <div class="mb-2">
                    <small class="text-light">Savings Balance</small><br>
                    <strong class="text-white">{{ bal['total_balance'] | isk }}</strong>
                    {% if bal['pending_interest'] > 0 %}
                    <small class="text-success">(incl. ~{{ bal['pending_interest'] | isk }} pending)</small>
                    {% endif %}
                </div>
                <div class="mb-3">
                    <small class="text-light">Remaining</small><br>
                    <strong class="text-white">{{ bal['remaining'] | isk }}</strong>
                </div>

                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar
                        {% if bal['progress'] >= 100 %}bg-primary
                        {% elif bal['progress'] >= 50 %}bg-success
                        {% else %}bg-info{% endif %}"
                        role="progressbar"
                        style="width: {{ bal['progress'] }}%"
                        aria-valuenow="{{ bal['progress'] }}"
                        aria-valuemin="0" aria-valuemax="100">
                        {{ "%.1f" | format(bal['progress']) }}%
                    </div>
                </div>
                {% if bal['eligible_balance'] is defined and bal['eligible_balance'] < bal['savings_balance'] %}
                <small class="text-secondary">New deposits earn interest after 30 days</small>
                {% endif %}
                {% elif order['status'] == 'pending_approval' %}
                <div class="mb-3">
                    <p class="text-warning mb-0">Awaiting admin approval...</p>
                </div>
                {% elif order['status'] == 'active' and order['amount_deposited'] == 0 %}
                <div class="mb-3">
                    <p class="text-info mb-0">Goal approved! Send ISK to <strong class="text-white">Bernie May Doff</strong> in-game to start saving.</p>
                </div>
                {% endif %}

                {% if order['status'] not in ('pending_approval',) %}
                <a href="{{ url_for('order_detail', order_id=order['id']) }}" class="btn btn-outline-light btn-sm">
                    View Details
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- How to Deposit - always accessible -->
<div class="card bg-secondary bg-opacity-25 border-secondary mt-2 mb-4">
    <div class="card-body">
        <a class="text-info text-decoration-none" data-bs-toggle="collapse" href="#depositHelp" role="button" aria-expanded="false">
            How do I make a deposit? <small class="text-secondary">(click to expand)</small>
        </a>
        <div class="collapse mt-3" id="depositHelp">
            <ol class="text-light mb-0">
                <li>Open EVE Online and send ISK <em>from the character whose goal you want to contribute to</em> to <strong class="text-white">Bernie May Doff</strong></li>
                <li>You can leave the <em>Reason</em> field blank</li>
                <li>The admin will sync the wallet and your deposit will appear here automatically</li>
                <li>If it doesn't appear within a day, contact the admin &mdash; they can also record deposits manually</li>
            </ol>
        </div>
    </div>
</div>
{% else %}
<div class="text-center mt-5 text-secondary">
    <p class="lead">No savings goals yet.</p>
    <a href="{{ url_for('catalog') }}" class="btn btn-success">Browse Available Ships</a>
</div>
{% endif %}
{% endblock %}
